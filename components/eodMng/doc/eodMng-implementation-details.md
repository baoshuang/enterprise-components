### `eodMng` implementation details 

#### Components:
End of day management module consists of following components:
- End of day manager (<eodMng.q>) - core of the whole module, it monitors rdb state (regarding eod) and triggers housekeeping and synchronization when needed (by detecting which hosts should be synchronized and passing necessary parameters to <hdbSync.q>); it also reports warnings and errors
- Housekeeping script (<hdbHk.q>) - is a plug-in based process that handles hdb housekeeping (deletion of old partitions, data compression, snapshots etc.); <hdbHk.q> has its own configuration specifying tasks that need to be performed (see <hdbHk.q> for details)
- Synchronization script (<hdbSync.q>) - uses rsync to synchronize hdb in two cases:
     1. - slave host pulls data from primary host 
     2. - primary host pushes data to slave hosts in cold standby for synchronization 
 
#### Status files:
 
 Each part of the module (each component) has its own status file
 
##### eodMng internal status file
 1. - File generated by end of day manager (<eodMng.q>) - used only internally to restore eodMng status in case of process restart
 `Status format`
```txt
 status next_eod_date last_update_time last_sync_host
```
 where
```txt
 next_eod_date - date of next end of day expected by eodMng
 last_update_time - time of the last update of the status (file is updated at regular time intervals)
 last_sync_host - host with which data was synchronized during last end of day, ‘none’ if no synchronization occurred – for example in case of a primary host)
```
 
 Example
```txt
 idle 2014.04.25 2014.04.25D10:40:00.000000000 none
```

File details
- Name - eodMngStatus
- Location - file located in data folder of the eodMng process
 
Available statuses
- unknown - initial state (right after process start) changes after first rdb status reading
- idle - end of day processing for the last day finished successfully and database is not performing any activities regarding end of day processing
- eod_during - end of day processing in progress
- housekeeping - performing housekeeping on rdb
- sync_with_cold - housekeeping finished - sending data to cold hosts (if any)
- sync_before - waiting for the primary host to be in the idle mode for the synchronization to start
- sync_during - synchronization with primary host in progress
- recovery - recoverable error during end of day processing occurred, however, the synchronization can still be performed (for now this situation occurs only when ‘wsfull signal is intercepted); if eodMng is in recovery state and none of the hosts with higher priority succeeded with end of day processing, hosts with lower priority are checked
- error - last end of day processing failed (eg. out of memory, out of disk space etc.), as a result data in hdb might be corrupted; if next end of day is successful, eodMng will be back into idle state; 

 *Notes*
 * Underlying cause of the error state is logged, please check the monitor or logfile for the eodMng
 * When housekeeping processes are completed on the primary host, the status is switched to idle (with date increased by 1 day) - this state indicates that all secondary hosts can synchronize data with it; please remember that active hosts pull data from primary host, while for cold hosts data is pushed by the primary host
 
##### hdbHk status file
 2. - File generated by housekeeping (<hdbHk.q>) - used to inform eodMng of housekeeping status
 *Status format*
```txt
 status timestamp
```

 where
```txt
 timestamp – timestamp of the status
```

 Example
```txt
 begin 2013.02.17T16:38:44.812
```

 *File details*
- Location - file located in data folder of eodMng process

 *Available statuses*
- begin - housekeeping in progress
- success - housekeeping process finished successfully
 
##### hdbSync status file
 4. - File generated by synchronization (<hdbSync.q>) - used to inform eodMng of synchronization status
 *Status format*
```txt
 status timestamp
```
 where
```txt
 timestamp – timestamp of the status
```
 Example
```txt
 sync_partition 2013.02.17T16:38:44.812
```
 *File details*
- Location - file located in data folder of eodMng process
 *Available statuses*
- begin - synchronization started - sym file backup
- sync_partition - sym backup completed, synchronizing current partition
- sync_all - sym backup completed, synchronizing current partition   
- success - synchronization successful
 *Notes*
  
  
##### Sample statuses of primary and secondary hosts:
 *Primary host*
```txt
 | Action                                      | eodMng status   |
 |---------------------------------------------|-----------------|
 | eodMng is waiting for EOD event             | idle            |
 | rdb starts EOD process                      | idle            |
 | eodMng reads EOD status file                | eod_during      |
 | rdb completes EOD process                   | eod_during      |
 | eodMng reads EOD status file                | housekeeping    |
 | eodMng starts housekeeping                  | housekeeping    |
 | housekeeping completed                      | sync_before     |
 | eodMng pushes data to cold hosts            | sync_with_cold  |
 | secondary hosts sync data with primary host | idle            |
```

 *Secondary host*
```txt
 | Action                                          | eodMng status |
 |-------------------------------------------------|---------------|
 | eodMng is waiting for EOD event                 | idle          |
 | rdb starts EOD process                          | idle          |
 | eodMng reads EOD status file                    | eod_during    |
 | rdb completes EOD process                       | eod_during    |
 | eodMng reads EOD status file                    | housekeeping  |
 | eodMng starts housekeeping                      | housekeeping  |
 | housekeeping completed                          | sync_before   |
 | eodMng waits for primary host to finish its EOD | sync_before   | 
 | secondary hosts pulls data from primary host    | sync_during   |
 | synchronisation completed successfully          | idle          |
```

